<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.portal.dao.extra.WorkFlowDao">
	<select id="selectlerkEverydayAchievenment" resultType="map"
		parameterType="map">
		select
			COUNT(1) achieveCount,
			SUM(pay_price) payPrice,
			SUM(actual_price) actualPrice,
			group_concat(distinct ei.name) phoneStaffName
		from order_info oi
		left join employee_info ei on oi.phone_staff_id = ei.id
		<trim prefix="where" prefixOverrides="and|or">
			<if test="userId != null">
				and receiver_staff_id = #{userId}
			</if>
			<if test="userList != null">
				and receiver_staff_id in
				<foreach collection="userList" index="index" item="item"
					open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
			<if test="dateInfo != null">
				and DATE_FORMAT(oi.create_date, '%Y-%m-%d') = #{dateInfo}
			</if>
		</trim>
		<if test="userId != null">
			GROUP BY receiver_staff_id
		</if>
	</select>

	<select id="selectlerkEverydayReception" resultType="map"
		parameterType="map">
		select
		count(1) receptionCount,
		FORMAT((TIME_TO_SEC(end_time) - TIME_TO_SEC(start_time))/60,1) stateTime
		from reception_info
		<trim prefix="where" prefixOverrides="and|or">
			<if test="userId != null">
				and receiver_staff_id = #{userId}
			</if>
			<if test="userList != null">
				and receiver_staff_id in
				<foreach collection="userList" index="index" item="item"
					open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
			<if test="dateInfo != null">
				and DATE_FORMAT(create_date, '%Y-%m-%d') = #{dateInfo}
			</if>
		</trim>
		<if test="userId != null">
			GROUP BY receiver_staff_id
		</if>
	</select>
	
	<select id="selectlerkEverydayTypeCount" resultType="map" parameterType="map">
		select case 
				when ci.type = 0 then '空白客户' 
				when ci.type = 1 then '重复登门' 
				when ci.type = 2 then '说明会' 
				when ci.type = 3 then '成单' 
				when ci.type = 4 then '锁定'
				when ci.type = 5 then '转介绍'
			end as typeName ,count(ci.type) typeCount
		from reception_info ri
		left join customer_info ci on ri.customer_id = ci.id
		<trim prefix="where" prefixOverrides="and|or">
			<if test="userId != null">
				and ri.receiver_staff_id = #{userId}
			</if>
			<if test="userList != null">
				and ri.receiver_staff_id in
				<foreach collection="userList" index="index" item="item"
					open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
			<if test="dateInfo != null">
				and DATE_FORMAT(ri.create_date, '%Y-%m-%d') = #{dateInfo}
			</if>
		</trim>
		GROUP BY ci.type
	</select>
	
	<select id="selectPhoneStaffName" resultType="java.lang.String">
		select group_concat(name) from employee_info where id in
		<foreach collection="array" index="index" item="item"
			open="(" separator="," close=")">
			#{item}
		</foreach>
	</select>
	
	<select id="selectClerkReceiveList" parameterType="map" resultType="map">
		SELECT ci.name as customerName,REPLACE(ci.phone, SUBSTR(ci.phone,4,4), '****') as customerPhone, 
			ri.start_time as startTime, ri.end_time as endTime, 
			ifnull(ri.order_id,' ') as orderNumber,
			case 
				when ci.type = 0 then '空白客户' 
				when ci.type = 1 then '重复登门' 
				when ci.type = 2 then '说明会' 
				when ci.type = 3 then '成单' 
				when ci.type = 4 then '锁定'
				when ci.type = 5 then '转介绍'
			end as typeName
		FROM `reception_info` ri
		left join customer_info ci on ri.customer_id = ci.id
		<trim prefix="where" prefixOverrides="and|or">
			<if test="receiverStaffId != null">
				and ri.receiver_staff_id = #{receiverStaffId}
			</if>
			<if test="createDate != null">
				and DATE_FORMAT(ri.create_date, '%Y-%m-%d') = DATE_FORMAT(#{createDate}, '%Y-%m-%d')
			</if>
		</trim>
		<include refid="common.Mysql_Pagination_Limit" />
	</select>
	
	<select id="selectClerkReceiveCount" parameterType="map" resultType="int">
		SELECT count(1)
		FROM `reception_info` ri
		left join customer_info ci on ri.customer_id = ci.id
		<trim prefix="where" prefixOverrides="and|or">
			<if test="receiverStaffId != null">
				and ri.receiver_staff_id = #{receiverStaffId}
			</if>
			<if test="createDate != null">
				and DATE_FORMAT(ri.create_date, '%Y-%m-%d') = DATE_FORMAT(#{createDate}, '%Y-%m-%d')
			</if>
		</trim>
	</select>
	
	<select id="selectClerkDayList" parameterType="map" resultType="map">
		select ei.id as employeeId, ei.name as employeeName, count(distinct oi.id) orderCount, 
			sum(distinct pay_price) payPrice, sum( distinct actual_price) actualPrice, count(distinct ri.id) receptionCount
		from employee_info ei
		left join reception_info ri on ri.receiver_staff_id = ei.id
		<if test="dateInfo != null">
			and DATE_FORMAT(ri.create_date, '%Y-%m-%d') = #{dateInfo}
		</if>
		left join order_info oi on ei.id = oi.receiver_staff_id
		<if test="dateInfo != null">
			and DATE_FORMAT(oi.create_date, '%Y-%m-%d') = #{dateInfo}
		</if>
		<trim prefix="where" prefixOverrides="and|or">
			<if test="userList != null">
				and ei.id in
				<foreach collection="userList" index="index" item="item"
					open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
		</trim>
		group by ei.id
	</select>
</mapper>